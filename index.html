<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js" charset="utf-8"></script>
    <title>Force Layout Example 3</title>
</head>

<style>

.node {
    fill: #ccc;
    stroke: #fff;
    stroke-width: 2px;
}

.link {
    stroke: #777;
    stroke-width: 2px;
}

button {
    position: absolute;
    width: 30px;
}
button#slow {
    margin-left: 40px;
}

</style>


<body>
    <button id='advance' title='Advance Layout One Increment'>
       <i class='fa fa-step-forward'></i>
   </button>
   <button id='slow'    title='Run Layout in Slow Motion'>
       <i class='fa fa-play'></i>
   </button>
<script>

// define the dimensions of the visualization

var width = 800,
    height = 800;

// here's where the code begins. we start off by creating an svg container
// to hold the visualization. we only need to specify the dimensions
// of this container.

var svg = d3.select('body').append('svg')
    .attr('width',width)
    .attr('height',height);

// before we do anything else, let's define the data for the visualization

var graph = {
    "nodes": [  { "x": 208.992345, "y": 273.053211 },
                { "x": 595.98896,  "y":  56.377057 },
                { "x": 319.568434, "y": 278.523637 },
                { "x": 214.494264, "y": 214.893585 },
                { "x": 482.664139, "y": 340.386773 },
                { "x":  84.078465, "y": 192.021902 },
                { "x": 196.952261, "y": 370.798667 },
                { "x": 107.358165, "y": 435.15643  },
                { "x": 401.168523, "y": 443.407779 },
                { "x": 508.368779, "y": 386.665811 },
                { "x": 355.93773,  "y": 460.158711 },
                { "x": 283.630624, "y":  87.898162 },
                { "x": 194.771218, "y": 436.366028 },
                { "x": 477.520013, "y": 337.547331 },
                { "x": 572.98129,  "y": 453.668459 },
                { "x": 106.717817, "y": 235.990363 },
                { "x": 265.064649, "y": 396.904945 },
                { "x": 452.719997, "y": 137.886092 }
            ],
    "links": [  { "target": 11, "source":  0 },
                { "target":  3, "source":  0 },
                { "target": 10, "source":  0 },
                { "target": 16, "source":  0 },
                { "target":  1, "source":  0 },
                { "target":  3, "source":  0 },
                { "target":  9, "source":  0 },
                { "target":  5, "source":  0 },
                { "target": 11, "source":  0 },
                { "target": 13, "source":  0 },
                { "target": 16, "source":  0 },
                { "target":  3, "source":  1 },
                { "target":  9, "source":  1 },
                { "target": 12, "source":  1 },
                { "target":  4, "source":  2 },
                { "target":  6, "source":  2 },
                { "target":  8, "source":  2 },
                { "target": 13, "source":  2 },
                { "target": 10, "source":  3 },
                { "target": 16, "source":  3 },
                { "target":  9, "source":  3 },
                { "target":  7, "source":  3 },
                { "target": 11, "source":  5 },
                { "target": 13, "source":  5 },
                { "target": 12, "source":  5 },
                { "target":  8, "source":  6 },
                { "target": 13, "source":  6 },
                { "target": 10, "source":  7 },
                { "target": 11, "source":  7 },
                { "target": 17, "source":  8 },
                { "target": 13, "source":  8 },
                { "target": 11, "source": 10 },
                { "target": 16, "source": 10 },
                { "target": 13, "source": 11 },
                { "target": 14, "source": 12 },
                { "target": 14, "source": 12 },
                { "target": 14, "source": 12 },
                { "target": 15, "source": 12 },
                { "target": 16, "source": 12 },
                { "target": 15, "source": 14 },
                { "target": 16, "source": 14 },
                { "target": 15, "source": 14 },
                { "target": 16, "source": 15 },
                { "target": 16, "source": 15 },
                { "target": 17, "source": 16 }
            ]
    };

// Extract the nodes and links from the data.
var nodes = graph.nodes,
    links = graph.links;

// now we create a force layout object and define its properties.
// those include the dimensions of the visualization and the arrays 
// of nodes and links

var force = d3.layout.force()
    .size([width,height])
    .nodes(nodes)
    .links(links);

// there is one more property of the layout we need to define: 'linkDistance'.
// that's generally a configurable value and, for a first example, we'd normally
// leave it at its default. 
// unfortunately, the default value results in a visualization that's not especially clear.
// the parameter defines the distance (normally in pixels) that we'd like to have
// between nodes that are connected. (it is, thus, the length we'd like our
// links to have.)

force.linkDistance(width/3.05);

// next we'll add the nodes and links to the visualization.
// note that we're just sticking them into the svg container at this point.
// we start with the links. the order here is important because we want the nodes
// to appear "on top of" the links. svg doesn't really have a convenient equivalent
// to html's 'z-index'; instead it relies on the order of the elements in the markup.
// by adding the nodes _after_ the links we ensure that nodes appear on top of links.

// links are pretty simple. they're just svg lines. we're going to position the
// lines according to the centers of their source and target nodes.
// note that the 'source' and 'target' properties are indices into the 'nodes'
// array. that's how our JSON is structured and that's how d3's force layout 
// expects its inputs. as soon as the layout begins executing, however,
// it's going to replace those properties with references to the actual
// node objects instead of indices.

var link = svg.selectAll('.link')
    .data(links)
    .enter().append('line')
    .attr('class','link')
    .attr('x1', function(d) { return nodes[d.source].x; })
    .attr('y1', function(d) { return nodes[d.source].y; })
    .attr('x2', function(d) { return nodes[d.target].x; })
    .attr('y2', function(d) { return nodes[d.target].y; })

// now it's the nodes turn. each node is drawn as a circle and given a radius
// and initial position within the svg container.
// as is normal with svg circles, the position is specified by the 'cx' and 'cy'
// attributes, which define the center of the circle.
// we actually don't have to position the nodes to start off, as the force layout
// is going to immediately move them. but this makes it a little easier
// to see what's going on before we start the layout executing.

var node = svg.selectAll('.node')
    .data(nodes)
    .enter().append('circle')
    .attr('class','node')
    .attr('r', width/100)
    .attr('cx', function(d) { return d.x; })
    .attr('cy', function(d) { return d.y; });

// before we get into the force layout operation itself, we define a variable
// that indicates whether or not we're animating the operation.
// initially, it's false.

var animating = false;

// we'll also define a variable that specifies the duration
// of each animation step (in milliseconds).

var animationStep = 400;

// next, we define a function that executes at each
// iteration of the force layout.

force.on('tick', function() {
    
    // when this function executes, the force layout
    // calculations have been updated. the layout will
    // have set various properties in our nodes and 
    // links objects that we can use to position them
    // within the svg container.
    
    // first let's reposition the nodes. as the force
    // layout runs it updates the 'x' and 'y' properties
    // that define where the node should be centered.
    // to move the node, we set the appropriate svg
    // attributes to their new values.
    
    // because we want to emphasize how the nodes and
    // links move, we use a transition to move them to
    // their positions instead of simply setting the 
    // values abruptly.
    
    node.transition().ease('linear').duration(animationStep)
        .attr('cx', function(d) { return d.x; })
        .attr('cy', function(d) { return d.y; });
    
    // we also need to update positions of the links.
    // for those elements, the force layout sets the
    // 'source' and 'target' properties, specifying
    // 'x' and 'y' values in each case.
    
    // here's where you can see how the force layout has
    // changed the 'source' and 'target' properties of
    // the links. now that the layout has executed at least
    // one iteration, the indices have been replaced by
    // references to the node objects.
    
    link.transition().ease('linear').duration(animationStep)
        .attr('x1', function(d) { return d.source.x; })
        .attr('y1', function(d) { return d.source.y; })
        .attr('x2', function(d) { return d.target.x; })
        .attr('y2', function(d) { return d.target.y; });
    
    // we only show one tick at a time, so stop the layout for now.
    
    force.stop();
    
    // if we're animating the layout, continue after
    // a delay to allow the animation to take effect.
    
    if (animating) {
        setTimeout(
            function() { force.start(); },
            animationStep
        );
    }
    
});

// now let's take care of the user interaction controls.
// we'll add functions to respond to clicks on the individual buttons.

// when the user clicks on the "Advance" button, we start the force layout
// (the tick handler will stop the layout after one iteration)

d3.select('#advance').on('click', force.start);

// when the user clicks on the "Play" button, we're going to
// run the force layout until it concludes.

d3.select('#slow').on('click', function() {
    
    // since the buttons don't have any effect any more,
    // disable them.
    
    d3.selectAll('button').attr('disabled','disabled');
    
    // indicate that the animation is in progress.
    
    animating = true;
    
    // start the animation
    
    force.start();
    
});

</script>
</body>
</html>
